{% load static %}
<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon"
      href="{% static 'favicon' %}{% if env_label != 'PROD' %}-{{ env_label|lower }}{% endif %}.png">
    <title>
        {% if env_label != "PROD" %}[{{ env_label }}] {% endif %}
        {% block title %}Medi HR - YOU&I 인사관리{% endblock %}
    </title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'tw/tailwind.css' %}">
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <style>
        .htmx-indicator {
            display: none;
        }
        .htmx-indicator.htmx-request {
            display: inline-flex;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
    {% include "tw/navbar.html" %}
    <div class="min-h-screen bg-[radial-gradient(circle_at_top,_rgba(13,148,136,0.08),transparent_45%)] min-[1920px]:pl-60 flex flex-col">
        <main class="pt-20 min-[1920px]:pt-6 flex-1">
            <div class="mx-auto w-full max-w-[1500px] px-4 pb-10 lg:px-6">
                <div id="page-errors" class="hidden mb-4 rounded-md border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-700"></div>
                {% block content %}{% endblock %}
            </div>
        </main>
        {% include "tw/footer.html" %}
    </div>

    <script>
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                var cookies = document.cookie.split(";");
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.body.addEventListener("htmx:configRequest", function (event) {
            event.detail.headers["X-CSRFToken"] = getCookie("csrftoken");
        });

        function findErrorBox(target) {
            if (!target) return null;

            // 1) target 자신이 error-box인 경우
            if (target.matches && target.matches("[data-error-box]")) return target;

            // 2) 가장 가까운 form 안의 error-box (신규/수정 모두 여기에 걸리게)
            var form = target.closest ? target.closest("form") : null;
            if (form) {
                var inForm = form.querySelector("[data-error-box]");
                if (inForm) return inForm;
            }

            // 3) 공용 fallback
            return document.getElementById("page-errors");
        }

        function showError(box, text) {
            if (!box) return;
            box.textContent = (text || "").trim() || "요청 처리 중 오류가 발생했습니다.";
            box.classList.remove("hidden");
        }

        function clearError(box) {
            if (!box) return;
            box.textContent = "";
            box.classList.add("hidden");
        }

        document.body.addEventListener("htmx:responseError", function (event) {
            var box = findErrorBox(event.target);
            showError(box, event.detail.xhr && event.detail.xhr.responseText);
        });

        document.body.addEventListener("htmx:afterRequest", function (event) {
            var box = findErrorBox(event.target);
            if (!box) return;
            if (event.detail.xhr && event.detail.xhr.status < 400) {
              clearError(box);
            }
        });

        function toast(message, level) {
            var root = document.getElementById("toast-root");
            if (!root) return;

            var wrap = document.createElement("div");
            var base = "rounded-xl border px-4 py-3 text-sm shadow-lg bg-white";
            var tone = "border-slate-200 text-slate-800";

            if (level === "success") tone = "border-teal-200 bg-teal-50 text-teal-900";
            if (level === "warning") tone = "border-amber-200 bg-amber-50 text-amber-900";
            if (level === "error")   tone = "border-rose-200 bg-rose-50 text-rose-900";

            wrap.className = base + " " + tone;
            wrap.textContent = message || "완료되었습니다.";

            root.appendChild(wrap);

            setTimeout(function () {
                wrap.classList.add("opacity-0");
                wrap.style.transition = "opacity 250ms ease";
            }, 2500);

            setTimeout(function () {
                if (wrap && wrap.parentNode) wrap.parentNode.removeChild(wrap);
            }, 2900);
        }

        // HTMX에서 HX-Trigger로 'toast' 이벤트를 받으면 토스트로 표시
        document.body.addEventListener("toast", function (event) {
            var detail = event.detail || {};
            toast(detail.message, detail.level || "success");
        });
    </script>

    <div id="toast-root" class="fixed top-20 left-1/2 z-[1200] w-[92vw] max-w-md -translate-x-1/2 space-y-2"></div>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
