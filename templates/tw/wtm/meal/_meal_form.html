<form
    id="meal-create-form"
    hx-post="{% url 'wtm:meals_new' %}"
    hx-target="#meal-table"
    hx-swap="outerHTML"
    hx-indicator="#meal-submit-indicator"
    class="flex flex-col gap-6"
>
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-12">
            <div class="flex flex-col gap-1 min-w-0 lg:col-span-3">
                <label class="text-sm font-medium text-slate-700" for="meal-used-date">사용일</label>
                <input id="meal-used-date" type="date" name="used_date" value="{{ used_date_default }}" required class="h-10 w-full max-w-[170px] rounded-md border border-slate-300 bg-white px-3 text-sm shadow-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200" />
            </div>
            <div class="flex flex-col gap-1 min-w-0 lg:col-span-3">
                <label class="text-sm font-medium text-slate-700" for="meal-approval-no">승인번호</label>
                <input id="meal-approval-no" type="text" name="approval_no" required class="h-10 w-full min-w-0 rounded-md border border-slate-300 bg-white px-3 text-sm shadow-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200" />
            </div>
            <div class="flex flex-col gap-1 min-w-0 lg:col-span-4">
                <label class="text-sm font-medium text-slate-700" for="meal-merchant">가맹점명</label>
                <input id="meal-merchant" type="text" name="merchant_name" required class="h-10 w-full min-w-0 rounded-md border border-slate-300 bg-white px-3 text-sm shadow-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200" />
            </div>
            <div class="flex flex-col gap-1 min-w-0 lg:col-span-2">
                <label class="text-sm font-medium text-slate-700" for="meal-amount">총액</label>
                <input id="meal-amount" type="number" name="amount" min="1" required class="h-10 w-full min-w-0 rounded-md border border-slate-300 bg-white px-3 text-sm shadow-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200" />
            </div>
        </div>

        <div class="rounded-xl border border-slate-200/70 bg-slate-50 px-4 py-4" data-participants data-total-input="#meal-amount">
            <div class="flex flex-wrap items-center justify-between gap-2">
                <div>
                    <div class="text-sm font-semibold text-slate-800">대상자 분배</div>
                    <div class="text-xs text-slate-500">분배 합계가 총액과 같아야 합니다.</div>
                </div>
                <div class="text-xs text-slate-600">
                    합계 <span data-participant-sum class="font-semibold text-slate-900">0</span> / 총액 <span data-participant-total class="font-semibold text-slate-900">0</span>
                    <span data-participant-warning class="ml-2 hidden rounded-full bg-rose-100 px-2 py-0.5 text-rose-700">합계 불일치</span>
                </div>
            </div>
            <div class="mt-4 space-y-2" data-participant-rows>
                <div class="flex flex-wrap items-center gap-2" data-participant-row>
                    <select name="participant_user" class="h-10 min-w-[160px] flex-1 rounded-md border border-slate-300 bg-white px-3 text-sm shadow-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200">
                        <option value="">대상자 선택</option>
                        {% for user in users %}
                            <option value="{{ user.id }}" {% if user.id == request.user.id %}selected{% endif %}>{{ user.emp_name }}</option>
                        {% endfor %}
                    </select>
                    <input
                        type="number"
                        name="participant_amount"
                        min="1"
                        placeholder="분배 금액"
                        data-participant-amount
                        class="h-10 w-32 rounded-md border border-slate-300 bg-white px-3 text-sm shadow-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200"
                    />
                    <button type="button" data-participant-remove class="h-10 rounded-md border border-slate-300 px-3 text-xs font-semibold text-slate-600 hover:bg-white">
                        제거
                    </button>
                </div>
            </div>
            <template data-participant-template>
                <div class="flex flex-wrap items-center gap-2" data-participant-row>
                    <select name="participant_user" class="h-10 min-w-[160px] flex-1 rounded-md border border-slate-300 bg-white px-3 text-sm shadow-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200">
                        <option value="">대상자 선택</option>
                        {% for user in users %}
                            <option value="{{ user.id }}">{{ user.emp_name }}</option>
                        {% endfor %}
                    </select>
                    <input
                        type="number"
                        name="participant_amount"
                        min="1"
                        placeholder="분배 금액"
                        data-participant-amount
                        class="h-10 w-32 rounded-md border border-slate-300 bg-white px-3 text-sm shadow-sm focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200"
                    />
                    <button type="button" data-participant-remove class="h-10 rounded-md border border-slate-300 px-3 text-xs font-semibold text-slate-600 hover:bg-white">
                        제거
                    </button>
                </div>
            </template>
            <div class="mt-3 flex flex-wrap items-center gap-3">
                <button type="button" data-participant-add class="inline-flex items-center gap-2 text-sm font-semibold text-teal-700 hover:text-teal-800">
                    + 대상자 추가
                </button>
                <button type="button" data-participant-distribute class="inline-flex items-center gap-2 text-sm font-semibold text-slate-600 hover:text-slate-800">
                    자동배분
                </button>
            </div>
        </div>

        <div class="flex items-center justify-end gap-3">
            <button type="button" data-modal-close class="inline-flex items-center rounded-md border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-white">
                닫기
            </button>
            <button type="submit" class="inline-flex items-center gap-2 rounded-md bg-teal-600 px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-teal-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-teal-500 focus-visible:ring-offset-2">
                등록
                <span id="meal-submit-indicator" class="htmx-indicator">
                    <svg class="h-4 w-4 animate-spin text-white" viewBox="0 0 24 24" aria-hidden="true">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v4a4 4 0 0 0-4 4H4z"></path>
                    </svg>
                </span>
            </button>
        </div>
        <div data-error-box id="meal-errors" class="hidden rounded-md border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-700"></div>
    </form>
