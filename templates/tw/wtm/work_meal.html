{% extends "tw/base.html" %}

{% block title %}식대 사용내역{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">
    <section class="rounded-2xl border border-slate-200/70 bg-white shadow-sm">
        <div class="flex flex-col gap-4 px-6 py-5 md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-2xl font-semibold text-slate-900">식대 사용내역</h1>
                <p class="text-sm text-slate-500">카드 승인 건별로 식대 사용 내역을 등록하고 분배 내역을 관리합니다.</p>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <button
                    type="button"
                    data-month-shift="-1"
                    class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-slate-300 bg-white text-slate-600 shadow-sm transition hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-teal-500 focus-visible:ring-offset-2"
                    aria-label="이전 달"
                >
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M12.78 15.53a.75.75 0 0 1-1.06 0l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 1 1 1.06 1.06L9.06 10l3.72 3.72a.75.75 0 0 1 0 1.06Z" clip-rule="evenodd" />
                    </svg>
                </button>
                <label class="sr-only" for="meal-month">조회 월</label>
                <input
                    id="meal-month"
                    type="month"
                    name="month"
                    value="{{ month_value }}"
                    hx-get="."
                    hx-trigger="change"
                    hx-target="#meal-table"
                    hx-swap="outerHTML"
                    hx-push-url="true"
                    hx-indicator="#meal-month-indicator"
                    class="h-10 rounded-md border border-slate-300 bg-white px-3 text-sm text-slate-900 shadow-sm transition focus:border-teal-500 focus:outline-none focus:ring-2 focus:ring-teal-200"
                />
                <button
                    type="button"
                    data-month-shift="1"
                    class="inline-flex h-10 w-10 items-center justify-center rounded-md border border-slate-300 bg-white text-slate-600 shadow-sm transition hover:bg-slate-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-teal-500 focus-visible:ring-offset-2"
                    aria-label="다음 달"
                >
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M7.22 4.47a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 1 1-1.06-1.06L10.94 10 7.22 6.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button
                    type="button"
                    data-modal-open
                    class="inline-flex items-center rounded-md bg-teal-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-teal-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-teal-500 focus-visible:ring-offset-2"
                >
                    신규 등록
                </button>
            </div>
        </div>
    </section>

    <div id="meal-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/40 p-4">
        <div class="w-full max-w-3xl rounded-2xl border border-slate-200 bg-white shadow-xl">
            <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4">
                <div>
                    <h2 class="text-lg font-semibold text-slate-900">신규 등록</h2>
                    <p class="text-xs text-slate-500">카드 승인 1건 단위로 입력합니다.</p>
                </div>
                <button type="button" data-modal-close class="rounded-full border border-slate-200 p-2 text-slate-500 hover:bg-slate-50">
                    <span class="sr-only">닫기</span>
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path d="M4.47 4.47a.75.75 0 0 1 1.06 0L10 8.94l4.47-4.47a.75.75 0 1 1 1.06 1.06L11.06 10l4.47 4.47a.75.75 0 0 1-1.06 1.06L10 11.06l-4.47 4.47a.75.75 0 0 1-1.06-1.06L8.94 10 4.47 5.53a.75.75 0 0 1 0-1.06z" />
                    </svg>
                </button>
            </div>
            <div class="px-6 py-5">
                {% include "tw/wtm/meal/_meal_form.html" %}
            </div>
        </div>
    </div>

    <div data-error-box id="meal-errors-table" class="hidden rounded-md border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-700"></div>

    {% include "tw/wtm/meal/_meal_table.html" %}
</div>
<div id="meal-month-indicator" class="htmx-indicator fixed right-6 top-20 z-50 text-slate-600">
    <div class="flex items-center gap-2 rounded-full border border-slate-200 bg-white/95 px-3 py-2 text-xs font-semibold shadow-lg">
        <svg class="h-4 w-4 animate-spin text-teal-600" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v4a4 4 0 0 0-4 4H4z"></path>
        </svg>
        불러오는 중
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    (function () {
        function parseNumber(value) {
            var num = parseInt(value, 10);
            return Number.isNaN(num) ? 0 : num;
        }

        function recalc(editor) {
            if (!editor) {
                return;
            }
            var totalSelector = editor.getAttribute("data-total-input");
            var totalInput = totalSelector ? document.querySelector(totalSelector) : null;
            var totalValue = totalInput ? parseNumber(totalInput.value) : 0;
            var sum = 0;
            var amountInputs = editor.querySelectorAll("[data-participant-amount]");
            amountInputs.forEach(function (input) {
                sum += parseNumber(input.value);
            });
            var sumTarget = editor.querySelector("[data-participant-sum]");
            if (sumTarget) {
                sumTarget.textContent = sum.toLocaleString();
            }
            var totalTarget = editor.querySelector("[data-participant-total]");
            if (totalTarget) {
                totalTarget.textContent = totalValue.toLocaleString();
            }
            var warningTarget = editor.querySelector("[data-participant-warning]");
            if (warningTarget) {
                if (totalValue > 0 && sum !== totalValue) {
                    warningTarget.classList.remove("hidden");
                } else {
                    warningTarget.classList.add("hidden");
                }
            }
            if (totalInput && amountInputs.length === 1) {
                var singleInput = amountInputs[0];
                if (!singleInput.value) {
                    singleInput.value = totalValue || "";
                    if (totalValue) {
                        recalc(editor);
                    }
                }
            }
        }

        function addRow(editor) {
            var template = editor.querySelector("[data-participant-template]");
            var rows = editor.querySelector("[data-participant-rows]");
            if (!template || !rows) {
                return;
            }
            var clone = template.content.cloneNode(true);
            rows.appendChild(clone);
            recalc(editor);
        }

        function removeRow(button) {
            var row = button.closest("[data-participant-row]");
            if (!row) {
                return;
            }
            var editor = button.closest("[data-participants]");
            row.remove();
            recalc(editor);
        }

        function initEditors(root) {
            var editors = (root || document).querySelectorAll("[data-participants]");
            editors.forEach(function (editor) {
                recalc(editor);
            });
        }

        function distribute(editor) {
            if (!editor) {
                return;
            }
            var totalSelector = editor.getAttribute("data-total-input");
            var totalInput = totalSelector ? document.querySelector(totalSelector) : null;
            var totalValue = totalInput ? parseNumber(totalInput.value) : 0;
            var rows = Array.from(editor.querySelectorAll("[data-participant-row]"));
            var validRows = rows.filter(function (row) {
                var select = row.querySelector("select[name='participant_user']");
                return select && select.value;
            });
            if (!validRows.length || totalValue <= 0) {
                return;
            }
            var base = Math.floor(totalValue / validRows.length);
            var remainder = totalValue % validRows.length;
            validRows.forEach(function (row, index) {
                var amountInput = row.querySelector("[data-participant-amount]");
                if (!amountInput) {
                    return;
                }
                var value = base + (index < remainder ? 1 : 0);
                amountInput.value = value || "";
            });
            recalc(editor);
        }

        document.addEventListener("click", function (event) {
            var addButton = event.target.closest("[data-participant-add]");
            if (addButton) {
                var editor = addButton.closest("[data-participants]");
                addRow(editor);
            }
            var removeButton = event.target.closest("[data-participant-remove]");
            if (removeButton) {
                removeRow(removeButton);
            }
            var distributeButton = event.target.closest("[data-participant-distribute]");
            if (distributeButton) {
                var distributeEditor = distributeButton.closest("[data-participants]");
                distribute(distributeEditor);
            }
            var modalOpen = event.target.closest("[data-modal-open]");
            if (modalOpen) {
                var modal = document.getElementById("meal-modal");
                if (modal) {
                    modal.classList.remove("hidden");
                    modal.classList.add("flex");
                }
            }
            var modalClose = event.target.closest("[data-modal-close]");
            if (modalClose) {
                var modalToClose = document.getElementById("meal-modal");
                if (modalToClose) {
                    modalToClose.classList.add("hidden");
                    modalToClose.classList.remove("flex");
                }
            }
            var shiftButton = event.target.closest("[data-month-shift]");
            if (shiftButton && monthInput) {
                var delta = parseInt(shiftButton.getAttribute("data-month-shift"), 10);
                var nextValue = shiftMonth(monthInput.value, delta);
                if (nextValue) {
                    monthInput.value = nextValue;
                    monthInput.dispatchEvent(new Event("change", { bubbles: true }));
                }
            }
        });

        document.addEventListener("input", function (event) {
            var editor = event.target.closest("[data-participants]");
            if (editor) {
                recalc(editor);
            }
        });

        var monthInput = document.getElementById("meal-month");
        function shiftMonth(value, delta) {
            if (!value) {
                return null;
            }
            var parts = value.split("-");
            if (parts.length !== 2) {
                return null;
            }
            var year = parseInt(parts[0], 10);
            var month = parseInt(parts[1], 10);
            if (Number.isNaN(year) || Number.isNaN(month)) {
                return null;
            }
            month += delta;
            if (month < 1) {
                month = 12;
                year -= 1;
            }
            if (month > 12) {
                month = 1;
                year += 1;
            }
            return year + "-" + String(month).padStart(2, "0");
        }

        document.body.addEventListener("htmx:afterSwap", function (event) {
            initEditors(event.target);
        });

        document.body.addEventListener("htmx:afterRequest", function (event) {
            var form = event.target;
            if (!form || form.id !== "meal-create-form") {
                return;
            }
            if (event.detail.xhr.status < 400) {
                var modal = document.getElementById("meal-modal");
                if (modal) {
                    modal.classList.add("hidden");
                    modal.classList.remove("flex");
                }
                form.reset();
                initEditors(form);
            }
        });

        initEditors(document);
    })();
</script>
{% endblock %}
