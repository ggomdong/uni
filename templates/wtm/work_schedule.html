{% extends 'base.html' %}
{% load pybo_filter %}
{% load static %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'print.css' %}" media="print">
{% endblock %}
{% block content %}
<div class="container my-3 schedule-page">

    <div class="page-header schedule-page-header">
        <h4 class="page-title">근무표</h4>
    </div>

    <div class="print-header">
        <div class="print-title">근무표</div>
        <div class="print-sub">{{ stand_ym|slice:"0:4" }}년 {{ stand_ym|slice:"4:6" }}월</div>
    </div>

    {# ------------------------------------------------------------------ #}
    {# 상단 컨트롤 바: 날짜 네비 + 버튼                                 #}
    {# ------------------------------------------------------------------ #}
    <div class="schedule-toolbar sticky-top bg-white border-bottom py-1 mb-3">
        <div class="d-flex align-items-center gap-2 flex-nowrap overflow-auto">
            <div class="d-flex align-items-center gap-2 flex-nowrap fs-4">
                <a href="{% url 'wtm:work_schedule' stand_ym|get_month:-1 %}">
                    <button type="button" class="btn-hover">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                             fill="currentColor" class="bi bi-chevron-left text-dark"
                             viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                  d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
                        </svg>
                    </button>
                </a>
                <a href="{% url 'wtm:work_schedule' stand_ym|get_month:1 %}">
                    <button type="button" class="btn-hover">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                             fill="currentColor" class="bi bi-chevron-right text-dark"
                             viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                  d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                        </svg>
                    </button>
                </a>

                <span class="nativeDatePicker">
                    <input type="month" id="selectYM" name="selectYM"
                           onkeydown="return false" onfocus="this.showPicker()"
                           value="{{ stand_ym|slice:'0:4' }}-{{ stand_ym|slice:'4:6' }}"/>
                </span>
            </div>

            <div class="ms-auto d-flex align-items-center gap-2 flex-nowrap flex-shrink-0 text-nowrap">
                {% if schedule_list %}
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnPrint">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer" viewBox="0 0 16 16">
                            <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/>
                            <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1"/>
                        </svg>
                        출력
                    </button>
                {% endif %}

                {% if user.is_authenticated %}
                    {% if schedule_list %}
                        <a href="javascript:void(0)" class="delete btn btn-sm btn-outline-danger"
                           data-uri="{% url 'wtm:work_schedule_delete' stand_ym %}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                 fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">
                                <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/>
                            </svg>
                            삭제
                        </a>
                        <a href="{% url 'wtm:work_schedule_modify' stand_ym %}" class="btn btn-sm btn-outline-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                 fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4Z"/>
                            </svg>
                            수정
                        </a>
                    {% else %}
                        <a href="{% url 'wtm:work_schedule_reg' stand_ym %}" class="btn btn-sm btn-outline-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                 fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                      d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                            </svg>
                            신규
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    {% if schedule_list %}
        {% now "Ym" as yearmonth %}
        {% now "j" as today %}

        {# grid 컬럼 정의를 커스텀 프로퍼티로 “한 번만” 만들어서 헤더/본문 공통으로 씀 #}
        <div class="schedule-grid"
              style="--wtm-cols: var(--wtm-dept-w) var(--wtm-name-w)
                {% for key, value in day_list.items %}
                  var(--wtm-day-w)
                  {% if value == '일' %}
                    {% if not forloop.last %}
                      var(--wtm-week-gap-w)
                    {% elif next_day_list %}
                      var(--wtm-week-gap-w)
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% for key, value in next_day_list.items %}
                  var(--wtm-day-w)
                  {% if value == '일' and not forloop.last %}
                    var(--wtm-week-gap-w)
                  {% endif %}
                {% endfor %}
              ;">

            {# --------- GRID HEADER (sticky) --------- #}
            <div class="schedule-grid-header">
                <div class="schedule-grid-row schedule-grid-row-head">
                    <div class="schedule-grid-cell head signcol"></div>
                    <div class="schedule-grid-cell head left1"></div>
                    <div class="schedule-grid-cell head left2"></div>

                    {% for key, value in day_list.items %}
                        <div class="schedule-grid-cell head day">
                            <div {% if key|to_int in holiday_list %}style="color: red"{% endif %}
                                 {% if yearmonth == stand_ym and key == today %}class="roundtext"{% endif %}>
                                {{ key }}
                            </div>
                        </div>
                        {% if value == '일' %}
                            {% if not forloop.last %}
                                <div class="schedule-grid-cell week-gap"></div>
                            {% elif next_day_list %}
                                <div class="schedule-grid-cell week-gap"></div>
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    {% for key, value in next_day_list.items %}
                        <div class="schedule-grid-cell head day">
                            <div class="next" {% if key|to_int in next_holiday_list %}style="color: red"{% endif %}>
                                {{ key }}
                            </div>
                        </div>
                        {% if value == '일' and not forloop.last %}
                            <div class="schedule-grid-cell week-gap"></div>
                        {% endif %}
                    {% endfor %}
                </div>

                <div class="schedule-grid-row schedule-grid-row-head">
                    <div class="schedule-grid-cell head signcol">서명</div>
                    <div class="schedule-grid-cell head left1">부서</div>
                    <div class="schedule-grid-cell head left2">성명</div>

                    {% for key, value in day_list.items %}
                        <div class="schedule-grid-cell head day">
                            <div {% if key|to_int in holiday_list %}style="color: red"{% endif %}
                                 {% if yearmonth == stand_ym and key == today %}class="roundtext"{% endif %}>
                                {{ value }}
                            </div>
                        </div>
                        {% if value == '일' %}
                            {% if not forloop.last %}
                                <div class="schedule-grid-cell week-gap"></div>
                            {% elif next_day_list %}
                                <div class="schedule-grid-cell week-gap"></div>
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    {% for key, value in next_day_list.items %}
                        <div class="schedule-grid-cell head day">
                            <div class="next" {% if key|to_int in next_holiday_list %}style="color: red"{% endif %}>
                                {{ value }}
                            </div>
                        </div>
                        {% if value == '일' and not forloop.last %}
                            <div class="schedule-grid-cell week-gap"></div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            {# --------- GRID BODY --------- #}
            <div class="schedule-grid-body">
                <div class="schedule-grid-row schedule-grid-spacer-row">
                    <div class="schedule-grid-spacer"></div>
                </div>
                {% for schedule in schedule_list %}

                    {% if schedule.dept_diff == 'Y' and not forloop.first %}
                        <div class="schedule-grid-row schedule-grid-divider-row">
                            <div class="schedule-grid-divider"></div>
                        </div>
                    {% endif %}

                    <div class="schedule-grid-row schedule-grid-row-data">
                        <div class="schedule-grid-cell signcol align-middle">
                            <div class="signature-box"></div>
                        </div>
                        <div class="schedule-grid-cell left1 align-middle">{{ schedule.dept }}</div>
                        <div class="schedule-grid-cell left2 align-middle">{{ schedule.emp_name }}</div>

                        {% for key, value in day_list.items %}
                            <div class="schedule-grid-cell day {% if yearmonth == stand_ym and key == today %}is-today{% endif %}">
                                {% with schedule|get_day_index:key as day %}
                                    {% if stand_ym|concat_date:key < schedule.join_date or schedule.out_date < stand_ym|concat_date:key %}
                                        <div class="module_box-disabled"></div>
                                    {% else %}
                                        {% with day|split:',' as module %}
                                            {% with module.5|to_int as color %}
                                                <div class="module_box"
                                                     name="schedule_module"
                                                     style="cursor: pointer; background-color: {{ module_colors|get_index:color }};"
                                                     title="{{ module.2 }} {% if module.1 == '소정근로' or module.1 == '휴일근로' %}{{ module.3 }}~{{ module.4 }}{% endif %}"
                                                     {% if user.is_authenticated %}data-bs-toggle="modal"{% endif %}
                                                     data-bs-target="#scheduleModal"
                                                     data-id="{{ schedule.id }}"
                                                     data-name="{{ schedule.emp_name }}"
                                                     data-dept="{{ schedule.dept }}"
                                                     data-position="{{ schedule.position }}"
                                                     data-date="{{ stand_ym|concat_date:key }}"
                                                     data-module="{{ module.0 }}">
                                                    {% if module.1 == '휴일근로' %}
                                                        <font color="blue">
                                                            {{ module.3 }}<br>
                                                            {{ module.4 }}
                                                        </font>
                                                    {% elif module.1 == '유급휴무' %}
                                                        {{ module.2|slice:"0:2" }}<br>
                                                        {{ module.2|slice:"2:4" }}
                                                    {% elif module.1 == '무급휴무' %}
                                                        <font color="red">
                                                            {{ module.2|slice:"0:2" }}<br>
                                                            {{ module.2|slice:"2:4" }}
                                                        </font>
                                                    {% elif module.1 == 'OFF' %}
                                                        -
                                                    {% else %}
                                                        {{ module.3 }}<br>
                                                        {{ module.4 }}
                                                    {% endif %}
                                                </div>
                                            {% endwith %}
                                        {% endwith %}
                                    {% endif %}
                                {% endwith %}
                            </div>
                            {% if value == '일' %}
                                {% if not forloop.last %}
                                    <div class="schedule-grid-cell week-gap"></div>
                                {% elif next_day_list %}
                                    <div class="schedule-grid-cell week-gap"></div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}

                        {% for key, value in next_day_list.items %}
                            <div class="schedule-grid-cell day">
                                {% with schedule|get_next_index:key as day %}
                                    {% if next_ym|concat_date:key < schedule.join_date or schedule.out_date < next_ym|concat_date:key %}
                                        <div class="module_box-disabled"></div>
                                    {% else %}
                                        {% with day|split:',' as module %}
                                            {% with module.5|to_int as color %}
                                                <div class="module_box"
                                                     name="schedule_module"
                                                     style="cursor: pointer; background-color: {{ module_colors|get_index:color }};"
                                                     {% if user.is_authenticated %}data-bs-toggle="modal"{% endif %}
                                                     data-bs-target="#scheduleModal"
                                                     data-id="{{ schedule.id }}"
                                                     data-name="{{ schedule.emp_name }}"
                                                     data-dept="{{ schedule.dept }}"
                                                     data-position="{{ schedule.position }}"
                                                     data-date="{{ next_ym|concat_date:key }}"
                                                     data-module="{{ module.0 }}">
                                                    {% if module.1 == '휴일근로' %}
                                                        <font color="blue">
                                                            {{ module.3 }}<br>
                                                            {{ module.4 }}
                                                        </font>
                                                    {% elif module.1 == '유급휴무' %}
                                                        {{ module.2|slice:"0:2" }}<br>
                                                        {{ module.2|slice:"2:4" }}
                                                    {% elif module.1 == '무급휴무' %}
                                                        <font color="red">
                                                            {{ module.2|slice:"0:2" }}<br>
                                                            {{ module.2|slice:"2:4" }}
                                                        </font>
                                                    {% elif module.1 == 'OFF' %}
                                                        -
                                                    {% else %}
                                                        {{ module.3 }}<br>
                                                        {{ module.4 }}
                                                    {% endif %}
                                                </div>
                                            {% endwith %}
                                        {% endwith %}
                                    {% endif %}
                                {% endwith %}
                            </div>
                            {% if value == '일' and not forloop.last %}
                                <div class="schedule-grid-cell week-gap"></div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <div class="text-center py-5">근무표가 없습니다.</div>
    {% endif %}
</div>

{% include 'wtm/modal_schedule.html' %}

{% endblock %}
{% block script %}
<script type="text/javascript">
const btnPrint = document.getElementById("btnPrint");
if (btnPrint) {
    btnPrint.addEventListener("click", function() {
        window.print();
    });
}

const delete_elements = document.getElementsByClassName("delete");
Array.from(delete_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        if (confirm("정말 삭제하시겠습니까?")) {
            location.href = this.dataset.uri;
        }
    });
});

const selectYM = document.getElementById("selectYM");
selectYM.addEventListener('change', function() {
    target = selectYM.value.replace('-', '');
    location.href = target;
});

const module_elements = document.getElementsByName("schedule_module");
Array.from(module_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        document.getElementById('module_info').textContent =
            this.dataset.position + " " + this.dataset.name + "(" + this.dataset.dept + "), " +
            this.dataset.date.substring(0,4) + "-" + this.dataset.date.substring(4,6) + "-" + this.dataset.date.substring(6,8);

        document.querySelector("input[type='hidden'][name='user_id']").value = this.dataset.id;
        document.querySelector("input[type='hidden'][name='stand_date']").value = this.dataset.date;
        document.querySelector("input[type='hidden'][name='module_id']").value = this.dataset.module;

        document.getElementById(this.dataset.module).checked = true;
    });
});
</script>
{% endblock %}
