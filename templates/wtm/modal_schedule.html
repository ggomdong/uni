{% load pybo_filter %}
{% block content %}
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="scheduleModalLabel">근무표 수정</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form" method="post" action="{% url 'wtm:work_schedule_popup' %}">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ initial_user_id|default_if_none:'' }}">
                <input type="hidden" name="stand_date" value="{{ initial_stand_date|default_if_none:'' }}">
                <input type="hidden" name="module_id" value="{{ initial_module_id|default_if_none:'' }}">
                <!-- 모달을 띄운 부모가 index인지 확인하기 위한 필드 -->
                <input type="hidden" name="from_index" id="fromIndexInput" value="">
                <div class="container my-3">
                    <!-- module 정보 표시 -->
                    <div class="mb-3 col-md-6">
                        <div class="alert alert-warning" role="alert">
                            <div id="module_info"></div>
                        </div>
                    </div>

                    <table class="text-center table-borderless my-4">
                        <tr>
                            {% for module in module_list %}
                            <th style="vertical-align: bottom; width: 50px; font-weight: normal;">
                            <input type="radio" class="invisible-radio" name="module" id="{{module.id}}" value="{{module.id}}">
                            <label class="form-label" for="{{module.id}}">
                                <div class="module_box" style="background-color: {{ module_colors|get_index:module.color }};">
                                    {% if module.cat == '휴일근로' %}
                                    <font color="blue">
                                        {{ module.start_time }}
                                        {{ module.end_time }}
                                    </font>
                                    {% elif module.cat == '유급휴무' %}
                                    {{ module.name|slice:"0:2" }}<br>
                                    {{ module.name|slice:"2:4" }}
                                    {% elif module.cat == '무급휴무' %}
                                    <font color="red">
                                    {{ module.name|slice:"0:2" }}<br>
                                    {{ module.name|slice:"2:4" }}
                                    </font>
                                    {% elif module.cat == 'OFF' %}
                                    -
                                    {% else %}
                                    {{ module.start_time }}
                                    {{ module.end_time }}
                                    {% endif %}
                                </div>
                            </label>
                            </th>
                            {% endfor %}
                        </tr>
                        <tr>
                            {% for module in module_list %}
                            <th style="width: 50px; font-weight: normal; font-size: 10px">
                                {{ module.name }}
                            </th>
                            {% endfor %}
                        </tr>
                    </table>
                </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="modify btn btn-primary">수정</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script type="text/javascript">
const modify_elements = document.getElementsByClassName("modify");
Array.from(modify_elements).forEach(function(element) {
  element.addEventListener('click', function() {
    const oldModuleId = document.querySelector("input[type='hidden'][name='module_id']");
    const moduleIdSelected = document.querySelector("input[type='radio'][name='module']:checked");

    if (moduleIdSelected === null) {
      alert("모듈 선택 후 수정하기 버튼을 누르세요.");
    } else if(oldModuleId.value == moduleIdSelected.value) {
      alert("변경사항이 없습니다.");
    } else if(confirm("수정하시겠습니까?")) {
      document.querySelector("input[type='hidden'][name='module_id']").value = moduleIdSelected.value;
      document.getElementById('form').submit();
    };
  });
});
</script>
{% endblock %}