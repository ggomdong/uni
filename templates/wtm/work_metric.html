{% extends 'base.html' %}
{% load pybo_filter %}
{% block content %}
<div class="container-fluid my-3 px-4">

    <div class="page-header">
        <h4 class="page-title">근태기록 ▸ 월간집계</h4>
    </div>

    {% now "Ymd" as nowymd %}
    {% with nowym=nowymd|slice:":6" nowd=nowymd|slice:"6:" %}

    {# ------------------------------------------------------------------ #}
    {# 상단 컨트롤 바: 날짜 네비 + 지표 네비 + 엑셀                             #}
    {# ------------------------------------------------------------------ #}
    <div class="row align-items-center mb-3 g-2">
        {# 왼쪽: 날짜 네비 #}
        <div class="col-lg-5 col-md-6 col-12">
            <div class="d-flex align-items-center gap-2 flex-wrap fs-4">
                <a href="{% url 'wtm:work_metric' metric stand_ym|get_month:-1 %}">
                    <button type="button" class="btn-hover">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                             fill="currentColor" class="bi bi-chevron-left text-dark"
                             viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                  d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
                        </svg>
                    </button>
                </a>
                <a href="{% url 'wtm:work_metric' metric stand_ym|get_month:1 %}">
                    <button type="button" class="btn-hover">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                             fill="currentColor" class="bi bi-chevron-right text-dark"
                             viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                  d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                        </svg>
                    </button>
                </a>

                <span class="nativeDatePicker">
                    <input type="month" id="selectYM" name="selectYM" onkeydown="return false" onfocus="this.showPicker()"
                    value="{{stand_ym|slice:'0:4'}}-{{stand_ym|slice:'4:6'}}"/>
                </span>
            </div>
        </div>

        <!-- 오른쪽: 지표 필터 + Excel 버튼 -->
        <div class="col-lg-7 col-md-6 col-12 text-md-end text-start mt-2 mt-md-0">
            <div class="d-flex flex-wrap align-items-center justify-content-md-end">

                <div class="btn-group metric-filter me-2" role="group" aria-label="근태 지표 필터">
                    <a href="{% url 'wtm:work_status' stand_ym %}"
                       class="btn btn-sm {% if active_metric == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        전체
                    </a>
                    <a href="{% url 'wtm:work_metric' 'late' stand_ym %}"
                       class="btn btn-sm {% if active_metric == 'late' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        지각
                    </a>
                    <a href="{% url 'wtm:work_metric' 'early' stand_ym %}"
                       class="btn btn-sm {% if active_metric == 'early' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        조퇴
                    </a>
                    <a href="{% url 'wtm:work_metric' 'overtime' stand_ym %}"
                       class="btn btn-sm {% if active_metric == 'overtime' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        연장근로
                    </a>
                    <a href="{% url 'wtm:work_metric' 'holiday' stand_ym %}"
                       class="btn btn-sm {% if active_metric == 'holiday' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        휴일근로
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive metric-table-wrapper">
        <table class="table table-sm table-bordered align-middle text-center work-metric-table">
            <colgroup>
              <col style="width:5%;">  <!-- 부서 -->
              <col style="width:5%;">  <!-- 성명 -->
              <col style="width:3%;">   <!-- 횟수 -->
              <col style="width:5%;">   <!-- 합계 -->
              {% for key, dow in day_list.items %}
                <col style="width:3%;">
              {% endfor %}
            </colgroup>
            <thead>
                <tr class="table-light">
                    <th rowspan="2" style="min-width:80px">부서</th>
                    <!--          <th rowspan="2" style="min-width:80px">직위</th>-->
                    <th rowspan="2" style="min-width:80px">성명</th>
                    <th rowspan="2">횟수</th>
                    <th rowspan="2">합계</th>

                    {% for key, dow in day_list.items %}
                    {% with dd=key|add:""|stringformat:"s" %}
                    <th>
                        <div
                        {% if dow == '일' or key|to_int in holiday_list %}style="color:red"{% endif %}
                        {% if stand_ym == nowym and dd == nowd %}class="roundtext"{% endif %}
                        >{{ key }}</div>
                    </th>
                    {% endwith %}
                    {% endfor %}
                </tr>
                <tr class="table-light">
                    {% for key, dow in day_list.items %}
                    {% with dd=key|add:""|stringformat:"s" %}
                    <th>
                        <div
                        {% if dow == '일' or key|to_int in holiday_list %}style="color:red"{% endif %}
                        {% if stand_ym == nowym and dd == nowd %}class="roundtext"{% endif %}
                        >{{ dow }}</div>
                    </th>
                    {% endwith %}
                    {% endfor %}
                </tr>
            </thead>

            <tbody>
                {% for r in rows %}
                <tr>
                    <td>{{ r.dept }}</td>
                    <!--            <td>{{ r.position }}</td>-->
                    <td>{{ r.emp_name }}</td>
                    <td class="fw-semibold">{{ r.count|default:"" }}</td>
                    <td class="fw-semibold">{{ r.total_seconds|ss_to_hhmmss }}</td>

                    {% for sec in r.cells %}
                    {% if sec > 0 %}
                    <td>{{ sec|ss_to_hhmmss }}</td>
                    {% else %}
                    <td class="text-muted"></td>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% endwith %}
</div>

<script type="text/javascript">
const selectYM = document.getElementById("selectYM");
selectYM.addEventListener('change', function() {
  target = selectYM.value.replace('-', '');
  location.href = target;
});
</script>
{% endblock %}