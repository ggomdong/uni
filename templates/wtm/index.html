{% extends 'base.html' %}
{% load pybo_filter %}
{% block content %}
<div class="container my-3 index-page">

    {# ------------------------------------------------------------------ #}
    {# 상단 컨트롤 바 : 날짜 네비 + 안내                                 #}
    {# ------------------------------------------------------------------ #}
    <div class="row align-items-center mb-3 g-2">
        {# 왼쪽: 날짜 네비 (근태기록-일별상세와 동일한 구조, url만 index로) #}
        <div class="col-md-6 col-12">
            <div class="d-flex align-items-center gap-2 flex-wrap fs-4">
                <a href="{% url 'wtm:index' stand_day|get_day:-1 %}">
                    <button type="button" class="btn-hover">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                             fill="currentColor" class="bi bi-chevron-left text-dark"
                             viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                  d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
                        </svg>
                    </button>
                </a>
                <a href="{% url 'wtm:index' stand_day|get_day:1 %}">
                    <button type="button" class="btn-hover">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                             fill="currentColor" class="bi bi-chevron-right text-dark"
                             viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                  d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                        </svg>
                    </button>
                </a>

                <input type="text"
                       readonly
                       class="uniTodayDate"
                       onkeydown="return false"
                       onfocus="this.showPicker()"
                       value="{{stand_day|slice:'0:4'}}-{{stand_day|slice:'4:6'}}-{{stand_day|slice:'6:8'}} ({{days}})"/>

                <span class="nativeDatePicker">
                <input type="date"
                       class="uniTodayDatePicker"
                       id="selectDay"
                       name="selectDay"
                       onkeydown="return false"
                       onfocus="this.showPicker()"
                       value="{{stand_day|slice:'0:4'}}-{{stand_day|slice:'4:6'}}-{{stand_day|slice:'6:8'}}"/>
            </span>
            </div>
        </div>
    </div>

    {% if user_list %}

    {# 1) 부서별 근무 카드 – 그리드(한 줄에 여러 개) #}
    <div class="row g-3 mb-3">
        {% for users in user_list %}
        <div class="col-6 col-sm-2">
            <div class="card index-dept-card h-100">
                <div class="index-dept-card-header">
                    <div class="index-dept-name text-truncate">
                        {{ users.0.group_name }}
                    </div>
                    <div class="index-dept-counts">
                        <span class="index-count-chip">오전 {{ users.0.sum_am }}</span>
                        <span class="index-count-chip">오후 {{ users.0.sum_pm }}</span>
                    </div>
                </div>
                <div class="index-dept-card-body">
                    <table class="table table-sm mb-0 align-middle index-dept-table">
                        <thead>
                        <tr>
                            <th>직위</th>
                            <th>성명</th>
                            <th class="text-center">오전</th>
                            <th class="text-center">오후</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for user in users %}
                        {% if forloop.counter >= 2 %}
                        <tr>
                            <td class="text-nowrap">{{ user.position }}</td>
                            <td class="text-nowrap">{{ user.emp_name }}</td>
                            <td class="text-center">
                                {% if user.am == 1 %}
                                <span class="index-dot index-dot-on"></span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if user.pm == 1 %}
                                <span class="index-dot index-dot-on"></span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if forloop.last %}
                        {# 최대 인원수에 맞춰 빈 행 채우기 #}
                        {% with max_workers|get_range:forloop.counter as range %}
                        {% for i in range %}
                        <tr>
                            <td>&nbsp;</td><td></td><td></td><td></td>
                        </tr>
                        {% endfor %}
                        {% endwith %}
                        {% endif %}
                        {% endif %}
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {# 2) 개인별 상세 테이블 #}
    <div class="card shadow-sm border-0">

        <div class="card-body p-0">
            <div class="table-responsive">
                {% now "Ymd" as today_ymd %}
                {% now "Hi" as now_hi %}
                <table class="table table-sm table-hover table-bordered align-middle text-center index-att-table mb-0">
                    <colgroup>
                        <col style="width:6%;">  {# 부서 #}
                        <col style="width:8%;">  {# 직위 #}
                        <col style="width:8%;">  {# 성명 #}
                        <col style="width:10%;">  {# 근로구분 #}
                        <col style="width:5%;">  {# 시업 #}
                        <col style="width:5%;">  {# 종업 #}
                        <col style="width:8%;">  {# 출근 #}
                        <col style="width:8%;">  {# 퇴근 #}
                        <col style="width:10%;">  {# 상태 #}
                        <col style="width:8%;">  {# 지각 #}
                        <col style="width:8%;">  {# 조퇴 #}
                        <col style="width:8%;">  {# 연장 #}
                        <col style="width:8%;">  {# 휴일 #}
                    </colgroup>
                    <thead>
                    <tr>
                        <th>부서</th>
                        <th>직위</th>
                        <th>성명</th>
                        <th>근로구분</th>
                        <th>시업</th>
                        <th>종업</th>
                        <th class="mm-hdr-gray">출근</th>
                        <th class="mm-hdr-gray">퇴근</th>
                        <th class="mm-hdr-gray">상태</th>
                        <th class="mm-hdr-brown">지각</th>
                        <th class="mm-hdr-brown">조퇴</th>
                        <th class="mm-hdr-blue">연장</th>
                        <th class="mm-hdr-blue">휴일</th>
                    </tr>
                    </thead>

                    {% if work_list %}
                    <tbody>
                    {% for work in work_list %}
                    {% ifchanged work.dept %}
                    {% if not forloop.first %}
                    <tr class="table-group-divider">
                        <td colspan="100%"></td>
                    </tr>
                    {% endif %}
                    {% endifchanged %}

                    <tr>
                        <td class="text-nowrap ps-3">{{ work.dept }}</td>
                        <td class="text-nowrap">{{ work.position }}</td>
                        <td class="text-nowrap fw-semibold">{{ work.emp_name }}</td>
                        <td>{{ work.cat }}</td>
                        <td>{{ work.start_time }}</td>
                        <td>{{ work.end_time }}</td>

                        <td class="
                            {% if work.cat == 'OFF' and work.checkin_time %} bg-warning-subtle{% endif %}
                            {% if work.cat == '소정근로' or work.cat == '휴일근로' %}
                              {% if stand_day <= today_ymd and not work.checkin_time %}
                                  {% with start_hi=work.start_time|default:''|cut:':' %}
                                      {% if start_hi and now_hi >= start_hi %}bg-warning-subtle{% endif %}
                                  {% endwith %}
                              {% endif %}
                            {% endif %}
                        ">
                            {{ work.checkin_time|default_if_none:"" }}
                        </td>

                        <td class="{% if work.cat == 'OFF' and work.checkout_time %}bg-warning-subtle{% endif %}">
                            {{ work.checkout_time|default_if_none:"" }}
                        </td>

                        <td>
                            {% if work.status_codes %}
                                {% if 'ERROR' in work.status_codes %}
                                <button type="button"
                                        class="btn btn-sm btn-danger att-error-btn"
                                        data-user-id="{{ work.user_id }}"
                                        data-emp-name="{{ work.emp_name }}"
                                        data-dept="{{ work.dept }}"
                                        data-position="{{ work.position }}"
                                        data-stand-day="{{ stand_day }}"
                                        data-module-id="{{ work.module_id|default_if_none:'' }}">
                                    오류
                                </button>
                                {% elif 'PAY' in work.status_codes or 'NOPAY' in work.status_codes or 'OFF' in work.status_codes %}
                                -
                                {% else %}
                                  {{ work.status }}
                                {% endif %}
                            {% endif %}
                        </td>

                        <td class="{% if work.late_seconds %}text-danger fw-semibold{% endif %}">
                            {% if work.late_seconds %}{{ work.late_seconds|ss_to_hhmmss }}{% endif %}
                        </td>
                        <td class="{% if work.early_seconds %}text-danger fw-semibold{% endif %}">
                            {% if work.early_seconds %}{{ work.early_seconds|ss_to_hhmmss }}{% endif %}
                        </td>
                        <td class="{% if work.overtime_seconds %}text-primary fw-semibold{% endif %}">
                            {% if work.overtime_seconds %}{{ work.overtime_seconds|ss_to_hhmmss }}{% endif %}
                        </td>
                        <td class="{% if work.holiday_seconds %}text-primary fw-semibold{% endif %}">
                            {% if work.holiday_seconds %}{{ work.holiday_seconds|ss_to_hhmmss }}{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                    {% else %}
                    <tbody>
                    <tr>
                        <td colspan="100%" class="py-4 text-muted">
                            오늘 근무 데이터가 없습니다.
                        </td>
                    </tr>
                    </tbody>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>

    {% else %}
    <div class="card shadow-sm border-0">
        <div class="card-body py-4 text-center text-muted">
            근무표 데이터가 없습니다.
        </div>
    </div>
    {% endif %}

    {# 오류 버튼용 인라인 메뉴 #}
    <div id="errorInlineMenu"
         class="card shadow-sm position-absolute d-none"
         style="z-index: 1080; min-width: 140px;">
        <div class="list-group list-group-flush small">
            <button type="button"
                    class="list-group-item list-group-item-action"
                    data-action="schedule">
                근무표 수정
            </button>
            <button type="button"
                    class="list-group-item list-group-item-action"
                    data-action="log">
                근태기록 등록
            </button>
        </div>
    </div>

    {% include 'wtm/modal_schedule.html' %}
    {% include 'wtm/modal_log.html' %}

</div>
{% endblock %}

{% block script %}
{% load static %}
<script src="{% static 'modal_log.js' %}"></script>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function () {
  const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};

  const selectDay = document.getElementById("selectDay");
  if (selectDay) {
    selectDay.addEventListener('change', function() {
      const target = this.value.replace(/-/gi, '');
      if (target) {
        location.href = target;
      }
    });
  }

  const errorButtons = document.querySelectorAll('.att-error-btn');
  const menu         = document.getElementById('errorInlineMenu');
  let currentError   = null;

  function hideMenu() {
    if (!menu) return;
    menu.classList.add('d-none');
  }
  function showMenuAt(x, y) {
    if (!menu) return;
    menu.style.left = x + 'px';
    menu.style.top  = (y + 4) + 'px';
    menu.classList.remove('d-none');
  }

  errorButtons.forEach(function (btn) {
    btn.style.cursor = isAuthenticated ? 'pointer' : 'default';
    btn.addEventListener('click', function (e) {
      if (!isAuthenticated) return;
      e.stopPropagation();

      currentError = {
        userId:    this.dataset.userId,
        empName:   this.dataset.empName || '',
        dept:      this.dataset.dept || '',
        position:  this.dataset.position || '',
        standDay:  this.dataset.standDay,
        moduleId:  this.dataset.moduleId || ''
      };

      const rect = this.getBoundingClientRect();
      const x = rect.right + window.scrollX + 8;
      const y = rect.top + window.scrollY - 6;
      showMenuAt(x, y);
    });
  });

  document.addEventListener('click', function () {
    hideMenu();
  });

  if (menu) {
    menu.addEventListener('click', function (e) {
      e.stopPropagation();
    });

    const scheduleBtn = menu.querySelector('[data-action="schedule"]');
    const logBtn      = menu.querySelector('[data-action="log"]');

    if (scheduleBtn) {
      scheduleBtn.addEventListener('click', function () {
        if (!currentError) return;
        hideMenu();
        openScheduleModal(currentError);
      });
    }
    if (logBtn) {
      logBtn.addEventListener('click', function () {
        if (!currentError) return;
        hideMenu();
        openLogModal(currentError);
      });
    }
  }

  function openScheduleModal(err) {
    const modalEl = document.getElementById('scheduleModal');
    if (!modalEl) {
      alert('근무표 수정 모달(scheduleModal)이 이 화면에 포함되어 있지 않습니다.');
      return;
    }

    const userInput   = modalEl.querySelector("input[name='user_id']");
    const dateInput   = modalEl.querySelector("input[name='stand_date']");
    const moduleInput = modalEl.querySelector("input[name='module_id']");
    const fromIndexInput = modalEl.querySelector("input[name='from_index']");
    const infoDiv     = modalEl.querySelector('#module_info');

    if (userInput)   userInput.value   = err.userId || '';
    if (dateInput)   dateInput.value   = err.standDay || '';
    if (moduleInput) moduleInput.value = err.moduleId || '';
    if (fromIndexInput) fromIndexInput.value = "1";

    if (err.moduleId) {
      const radio = modalEl.querySelector(
        "input[type='radio'][name='module'][value='" + err.moduleId + "']"
      );
      if (radio) radio.checked = true;
    }

    if (infoDiv) {
      const y = err.standDay.substring(0,4);
      const m = err.standDay.substring(4,6);
      const d = err.standDay.substring(6,8);
      infoDiv.textContent = err.position + ' ' + err.empName + '(' + err.dept + '), ' + y + '-' + m + '-' + d;
    }

    const bsModal = new bootstrap.Modal(modalEl);
    bsModal.show();
  }

  function openLogModal(err) {
      const modalEl = document.getElementById('logModal');
      if (!modalEl) return;

      // 공용 JS(show.bs.modal)에서 읽을 데이터만 적재
      modalEl.dataset.mode = 'create';
      modalEl.dataset.userId = err.userId || '';
      // 등록은 id/workCode/recordTime 비움
      modalEl.dataset.id = '';
      modalEl.dataset.workCode = '';
      modalEl.dataset.recordTime = '';

      // stand_day/from_index는 지금처럼 직접 세팅(이건 페이지 맥락 값이니까)
      const standDayEl  = document.getElementById('logStandDayInput');
      const fromIndexEl = document.getElementById('logFromIndexInput');
      if (standDayEl)  standDayEl.value = err.standDay || '';
      if (fromIndexEl) fromIndexEl.value = "1";

      // userSelect 옵션을 1개로 바꿔 끼우던 로직은 그대로 유지하거나,
      // userSelect가 전체 user_list를 이미 가지고 있으면 생략해도 됨.
      const userSelect = document.getElementById('logUserSelect');
      if (userSelect) {
        const label = `${err.dept} / ${err.position} / ${err.empName}`;
        userSelect.innerHTML = `<option value="${err.userId}">${label}</option>`;
        userSelect.value = err.userId || '';
      }

      bootstrap.Modal.getOrCreateInstance(modalEl).show();
    }
});
</script>
{% endblock %}
