{% extends 'base.html' %}
{% load pybo_filter %}
{% block content %}
<div class="container-fluid my-3 px-4">

    <div class="page-header">
        <h4 class="page-title">근태기록 ▸ 월간집계</h4>
    </div>

    {# ------------------------------------------------------------------ #}
    {# 상단 컨트롤 바: 날짜 네비 + 지표 네비 + 엑셀                             #}
    {# ------------------------------------------------------------------ #}
    <div class="row align-items-center mb-3 g-2">
        {# 왼쪽: 날짜 네비 #}
        <div class="col-lg-5 col-md-6 col-12">
            <div class="d-flex align-items-center gap-2 flex-wrap fs-4">
                <a href="{% url 'wtm:work_status' stand_ym|get_month:-1 %}">
                    <button type="button" class="btn-hover">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                             fill="currentColor" class="bi bi-chevron-left text-dark"
                             viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                  d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
                        </svg>
                    </button>
                </a>
                <a href="{% url 'wtm:work_status' stand_ym|get_month:1 %}">
                    <button type="button" class="btn-hover">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                             fill="currentColor" class="bi bi-chevron-right text-dark"
                             viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                  d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                        </svg>
                    </button>
                </a>

                <span class="nativeDatePicker">
                    <input type="month" id="selectYM" name="selectYM" onkeydown="return false" onfocus="this.showPicker()"
                    value="{{stand_ym|slice:'0:4'}}-{{stand_ym|slice:'4:6'}}"/>
                </span>
            </div>
        </div>

        <!-- 오른쪽: 지표 필터 + Excel 버튼 -->
        <div class="col-lg-7 col-md-6 col-12 text-md-end text-start mt-2 mt-md-0">
            <div class="toolbar-right d-flex flex-wrap align-items-center justify-content-md-end justify-content-start gap-2">

                <div class="btn-group metric-filter" role="group" aria-label="근태 지표 필터">
                    <a href="{% url 'wtm:work_status' stand_ym %}"
                       class="btn btn-sm {% if active_metric == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        전체
                    </a>
                    <a href="{% url 'wtm:work_metric' 'late' stand_ym %}"
                       class="btn btn-sm {% if active_metric == 'late' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        지각
                    </a>
                    <a href="{% url 'wtm:work_metric' 'early' stand_ym %}"
                       class="btn btn-sm {% if active_metric == 'early' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        조퇴
                    </a>
                    <a href="{% url 'wtm:work_metric' 'overtime' stand_ym %}"
                       class="btn btn-sm {% if active_metric == 'overtime' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        연장근로
                    </a>
                    <a href="{% url 'wtm:work_metric' 'holiday' stand_ym %}"
                       class="btn btn-sm {% if active_metric == 'holiday' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        휴일근로
                    </a>
                </div>

                <!-- Export 슬롯: 항상 렌더링(자리 고정). 모바일에서는 통째로 숨김 -->
                <div class="export-slot d-none d-md-flex">
                    {% if user.is_authenticated and active_metric == 'all' %}
                    <a href="{% url 'wtm:work_status_excel' stand_ym %}" class="btn btn-sm btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                             class="bi bi-floppy-fill" viewBox="0 0 16 16">
                            <path d="M0 1.5A1.5 1.5 0 0 1 1.5 0H3v5.5A1.5 1.5 0 0 0 4.5 7h7A1.5 1.5 0 0 0 13 5.5V0h.086a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5H14v-5.5A1.5 1.5 0 0 0 12.5 9h-9A1.5 1.5 0 0 0 2 10.5V16h-.5A1.5 1.5 0 0 1 0 14.5z"/>
                            <path d="M3 16h10v-5.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5zm9-16H4v5.5a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5zM9 1h2v4H9z"/>
                        </svg>
                        Excel
                    </a>
                    {% else %}
                    <span class="export-placeholder"></span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive status-table-wrapper d-none d-md-block">
        <table class="table table-sm table-bordered align-middle text-center work-status-table">
            <colgroup>
                <col style="width:10%;">  <!-- 부서 -->
                <col style="width:9%;">   <!-- 성명 -->
                <col style="width:6%;">   <!-- 오류(일수) -->

                <!-- 소정근로: 지각/조퇴/연장근로 × (횟수,시간) = 6 -->
                <col style="width:5%;"><col style="width:8%;">
                <col style="width:5%;"><col style="width:8%;">
                <col style="width:5%;"><col style="width:8%;">

                <!-- 휴일근로: 근로/지각/조퇴/연장근로 × (횟수,시간) = 8 -->
                <col style="width:8%;">   <!-- TOTAL(시간) -->
                <col style="width:5%;"><col style="width:8%;">
                <col style="width:5%;"><col style="width:8%;">
                <col style="width:5%;"><col style="width:8%;">
                <col style="width:5%;"><col style="width:8%;">

                <!-- 무급휴무 -->
                <col style="width:6%;">
            </colgroup>

            <thead>
                <tr class="table-light">
                    <th rowspan="3">부서</th>
                    <th rowspan="3">성명</th>
                    <th rowspan="3">오류<br>(일수)</th>

                    <th colspan="6">소정근로</th>
                    <th colspan="9">휴일근로</th>
                    <th rowspan="3">무급휴무<br>(일수)</th>
                </tr>
                <tr class="table-light">
                    <th colspan="2">지각</th>
                    <th colspan="2">조퇴</th>
                    <th colspan="2">연장근로</th>

                    <th rowspan="2">TOTAL<br>(시간)</th>
                    <th colspan="2">근로</th>
                    <th colspan="2">지각</th>
                    <th colspan="2">조퇴</th>
                    <th colspan="2">연장근로</th>
                </tr>
                <tr class="table-light">
                    <th>횟수</th><th>시간</th>
                    <th>횟수</th><th>시간</th>
                    <th>횟수</th><th>시간</th>

                    <th>횟수</th><th>시간</th>
                    <th>횟수</th><th>시간</th>
                    <th>횟수</th><th>시간</th>
                    <th>횟수</th><th>시간</th>
                </tr>
            </thead>

            <tbody>
                {% for r in rows %}
                <tr>
                    <td class="text-nowrap">{{ r.dept }}</td>
                    <td class="text-nowrap">{{ r.emp_name }}</td>

                    <td>{{ r.error_cnt|default_if_none:""|default:"" }}</td>

                    {# ===== 소정근로 ===== #}
                    <td>{{ r.reg_late_cnt|default_if_none:""|default:"" }}</td>
                    <td>{% if r.reg_late_sec %}{{ r.reg_late_sec|ss_to_hhmmss }}{% endif %}</td>

                    <td>{{ r.reg_early_cnt|default_if_none:""|default:"" }}</td>
                    <td>{% if r.reg_early_sec %}{{ r.reg_early_sec|ss_to_hhmmss }}{% endif %}</td>

                    <td>{{ r.reg_overtime_cnt|default_if_none:""|default:"" }}</td>
                    <td>{% if r.reg_overtime_sec %}{{ r.reg_overtime_sec|ss_to_hhmmss }}{% endif %}</td>

                    {# ===== 휴일근로 ===== #}
                    <td>{% if r.total_sec %}{{ r.total_sec|ss_to_hhmmss }}{% endif %}</td>

                    <td>{{ r.hol_work_cnt|default_if_none:""|default:"" }}</td>
                    <td>{% if r.hol_work_sec %}{{ r.hol_work_sec|ss_to_hhmmss }}{% endif %}</td>

                    <td>{{ r.hol_late_cnt|default_if_none:""|default:"" }}</td>
                    <td>{% if r.hol_late_sec %}{{ r.hol_late_sec|ss_to_hhmmss }}{% endif %}</td>

                    <td>{{ r.hol_early_cnt|default_if_none:""|default:"" }}</td>
                    <td>{% if r.hol_early_sec %}{{ r.hol_early_sec|ss_to_hhmmss }}{% endif %}</td>

                    <td>{{ r.hol_overtime_cnt|default_if_none:""|default:"" }}</td>
                    <td>{% if r.hol_overtime_sec %}{{ r.hol_overtime_sec|ss_to_hhmmss }}{% endif %}</td>

                    <td>{{ r.nopay_cnt|default_if_none:""|default:"" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="19" class="py-5 text-muted">대상 직원이 없습니다.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# ===== 모바일 요약 테이블: 한눈용 ===== #}
    <div class="status-table-wrapper d-block d-md-none">
        <table class="table table-sm table-bordered work-status-mobile-table">
            <colgroup>
                <col style="width:22%;">  <!-- 직원 -->
                <col style="width:13%;">  <!-- 오류 -->
                <col style="width:13%;">  <!-- 지각 -->
                <col style="width:13%;">  <!-- 조퇴 -->
                <col style="width:13%;">  <!-- 연장 -->
                <col style="width:13%;">  <!-- 휴근 -->
                <col style="width:13%;">  <!-- 무급 -->
            </colgroup>
            <thead>
                <tr>
                    <th rowspan="2">직원</th>
                    <th rowspan="2">오류</th>
                    <th colspan="3">소정근로</th>
                    <th rowspan="2">휴근</th>
                    <th rowspan="2">무급</th>
                </tr>
                <tr>
                    <th>지각</th>
                    <th>조퇴</th>
                    <th>연장</th>
                </tr>
            </thead>
            <tbody>
                {% for r in rows %}
                <tr>
                    <td class="ws-namecell">
                        <span class="ws-dept">{{ r.dept }}</span>
                        <span class="ws-name">{{ r.emp_name }}</span>
                    </td>

                    <td class="ws-metric">
                        <div class="cnt {% if r.error_cnt %}ws-bad{% endif %}">
                        {% if r.error_cnt %}{{ r.error_cnt }}회{% else %}-{% endif %}
                        </div>
                        <div class="tm">&nbsp;</div>
                    </td>

                    <td class="ws-metric">
                        <div class="cnt {% if r.reg_late_cnt %}ws-warn{% endif %}">
                        {% if r.reg_late_cnt %}{{ r.reg_late_cnt }}회{% else %}-{% endif %}
                        </div>
                        <div class="tm">
                        {% if r.reg_late_sec %}{{ r.reg_late_sec|ss_to_hhmmss }}{% else %}-{% endif %}
                        </div>
                    </td>

                    <td class="ws-metric">
                        <div class="cnt {% if r.reg_early_cnt %}ws-warn{% endif %}">
                        {% if r.reg_early_cnt %}{{ r.reg_early_cnt }}회{% else %}-{% endif %}
                        </div>
                        <div class="tm">
                        {% if r.reg_early_sec %}{{ r.reg_early_sec|ss_to_hhmmss }}{% else %}-{% endif %}
                        </div>
                    </td>

                    <td class="ws-metric">
                        <div class="cnt {% if r.reg_overtime_cnt %}ws-good{% endif %}">
                        {% if r.reg_overtime_cnt %}{{ r.reg_overtime_cnt }}회{% else %}-{% endif %}
                        </div>
                        <div class="tm">
                        {% if r.reg_overtime_sec %}{{ r.reg_overtime_sec|ss_to_hhmmss }}{% else %}-{% endif %}
                        </div>
                    </td>

                    <td class="ws-metric">
                        <div class="cnt {% if r.hol_work_cnt %}ws-good{% endif %}">
                        {% if r.hol_work_cnt %}{{ r.hol_work_cnt }}회{% else %}-{% endif %}
                        </div>
                        <div class="tm">
                        {% if r.total_sec %}{{ r.total_sec|ss_to_hhmmss }}{% else %}-{% endif %}
                        </div>
                    </td>

                     <td class="ws-metric">
                        <div class="cnt {% if r.nopay_cnt %}ws-bad{% endif %}">
                        {% if r.nopay_cnt %}{{ r.nopay_cnt }}회{% else %}-{% endif %}
                        </div>
                        <div class="tm">&nbsp;</div>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="7" class="text-center text-muted py-4">대상 직원이 없습니다.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script type="text/javascript">
const selectYM = document.getElementById("selectYM");
selectYM.addEventListener('change', function() {
  const target = selectYM.value.replace('-', '');
  location.href = target;
});
</script>
{% endblock %}
