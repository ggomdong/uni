{% extends 'base.html' %}
{% load pybo_filter %}
{% block content %}
<form id="form" method="post">
    {% csrf_token %}

    <div class="container my-3 schedule-edit-page">

        <div class="page-header schedule-edit-page-header">
            <h4 class="page-title">근무표 등록/수정</h4>
        </div>

        {# ------------------------------------------------------------------ #}
        {# 상단 툴바(고정): 월 표시 + 버튼 + 모듈 팔레트                         #}
        {# ------------------------------------------------------------------ #}
        <div class="schedule-edit-toolbar sticky-top bg-white border-bottom py-1 mb-3">

            <div class="d-flex align-items-center gap-2 flex-nowrap">
                <div class="fs-5 fw-semibold text-nowrap">
                    {{ stand_ym|slice:"0:4" }}년 {{ stand_ym|slice:"4:6" }}월
                </div>

                <div class="ms-auto d-flex align-items-center gap-1 flex-nowrap text-nowrap">
                    <button type="button" id="undoBtn" class="btn btn-sm btn-outline-secondary me-1" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-90deg-left" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M1.146 4.854a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H12.5A2.5 2.5 0 0 1 15 6.5v8a.5.5 0 0 1-1 0v-8A1.5 1.5 0 0 0 12.5 5H2.707l3.147 3.146a.5.5 0 1 1-.708.708z"/>
                        </svg>
                    </button>

                    <button type="button" id="redoBtn" class="btn btn-sm btn-outline-secondary me-1" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-90deg-right" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M14.854 4.854a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 4H3.5A2.5 2.5 0 0 0 1 6.5v8a.5.5 0 0 0 1 0v-8A1.5 1.5 0 0 1 3.5 5h9.793l-3.147 3.146a.5.5 0 0 0 .708.708z"/>
                        </svg>
                    </button>

                    <a href="{% url 'wtm:work_schedule' stand_ym %}" class="btn btn-sm btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-backspace-fill" viewBox="0 0 16 16">
                            <path d="M15.683 3a2 2 0 0 0-2-2h-7.08a2 2 0 0 0-1.519.698L.241 7.35a1 1 0 0 0 0 1.302l4.843 5.65A2 2 0 0 0 6.603 15h7.08a2 2 0 0 0 2-2zM5.829 5.854a.5.5 0 1 1 .707-.708l2.147 2.147 2.146-2.147a.5.5 0 1 1 .707.708L9.39 8l2.146 2.146a.5.5 0 0 1-.707.708L8.683 8.707l-2.147 2.147a.5.5 0 0 1-.707-.708L7.976 8z"/>
                        </svg>
                        취소
                    </a>

                    <button type="button" class="save btn btn-sm btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-floppy-fill" viewBox="0 0 16 16">
                            <path d="M0 1.5A1.5 1.5 0 0 1 1.5 0H3v5.5A1.5 1.5 0 0 0 4.5 7h7A1.5 1.5 0 0 0 13 5.5V0h.086a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5H14v-5.5A1.5 1.5 0 0 0 12.5 9h-9A1.5 1.5 0 0 0 2 10.5V16h-.5A1.5 1.5 0 0 1 0 14.5z"/>
                            <path d="M3 16h10v-5.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5zm9-16H4v5.5a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5zM9 1h2v4H9z"/>
                        </svg>
                        저장
                    </button>
                </div>
            </div>

            {# 모듈 팔레트: 고정 툴바 내부, 가로 스크롤 #}
            <div class="module-palette mt-2">
                <div class="module-palette-scroll">
                    <table class="module-palette-table text-center">
                        <tr>
                            {% for module in module_list %}
                                <th class="module-palette-cell">
                                    <input type="radio" class="invisible-radio" name="module" id="{{ module.id }}" value="{{ module.id }}">
                                    <label class="form-label" for="{{ module.id }}">
                                        <div class="module_box" id="select{{ module.id }}" style="background-color: {{ module_colors|get_index:module.color }};">
                                            {% if module.cat == '휴일근로' %}
                                                <font color="blue">
                                                    {{ module.start_time }}<br>
                                                    {{ module.end_time }}
                                                </font>
                                            {% elif module.cat == '유급휴무' %}
                                                {{ module.name|slice:"0:2" }}<br>
                                                {{ module.name|slice:"2:4" }}
                                            {% elif module.cat == '무급휴무' %}
                                                <font color="red">
                                                    {{ module.name|slice:"0:2" }}<br>
                                                    {{ module.name|slice:"2:4" }}
                                                </font>
                                            {% elif module.cat == 'OFF' %}
                                                -
                                            {% else %}
                                                {{ module.start_time }}<br>
                                                {{ module.end_time }}
                                            {% endif %}
                                        </div>
                                    </label>
                                </th>
                            {% endfor %}
                        </tr>
                        <tr class="module-palette-names">
                            {% for module in module_list %}
                                <th class="module-palette-name">{{ module.name }}</th>
                            {% endfor %}
                        </tr>
                    </table>
                </div>
            </div>

        </div>

        {# ------------------------------------------------------------------ #}
        {# 본문: GRID (조회 화면과 동일 패턴)                                   #}
        {# ------------------------------------------------------------------ #}
        {% if user_list %}
            {% now "Ym" as yearmonth %}
            {% now "j" as today %}
            {% with day_list|length as day_len %}

            <div class="schedule-grid schedule-edit-grid"
                 style="--wtm-cols: var(--wtm-dept-w) var(--wtm-name-w)
                        {% for key, value in day_list.items %} var(--wtm-day-w) {% endfor %}
                        {% for key, value in next_day_list.items %} var(--wtm-day-w) {% endfor %};">

                {# --------- GRID HEADER (sticky) --------- #}
                <div class="schedule-grid-header">
                    <div class="schedule-grid-row schedule-grid-row-head">
                        <div class="schedule-grid-cell head left1"></div>
                        <div class="schedule-grid-cell head left2"></div>

                        {% for key, value in day_list.items %}
                            <div class="schedule-grid-cell head day" data-col="{{ forloop.counter0 }}">
                                <div {% if key|to_int in holiday_list %}style="color: red"{% endif %}
                                     {% if yearmonth == stand_ym and key == today %}class="roundtext"{% endif %}>
                                    {{ key }}
                                </div>
                            </div>
                        {% endfor %}

                        {% for key, value in next_day_list.items %}
                            <div class="schedule-grid-cell head day" data-col="{{ forloop.counter0|add:day_len }}">
                                <div class="next" {% if key|to_int in next_holiday_list %}style="color: red"{% endif %}>
                                    {{ key }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div class="schedule-grid-row schedule-grid-row-head">
                        <div class="schedule-grid-cell head left1">부서</div>
                        <div class="schedule-grid-cell head left2">성명</div>

                        {% for key, value in day_list.items %}
                            <div class="schedule-grid-cell head day" data-col="{{ forloop.counter0 }}">
                                <div {% if key|to_int in holiday_list %}style="color: red"{% endif %}
                                     {% if yearmonth == stand_ym and key == today %}class="roundtext"{% endif %}>
                                    {{ value }}
                                </div>
                            </div>
                        {% endfor %}

                        {% for key, value in next_day_list.items %}
                            <div class="schedule-grid-cell head day" data-col="{{ forloop.counter0|add:day_len }}">
                                <div class="next" {% if key|to_int in next_holiday_list %}style="color: red"{% endif %}>
                                    {{ value }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                {# --------- GRID BODY --------- #}
                <div class="schedule-grid-body">
                    <div class="schedule-grid-row schedule-grid-spacer-row">
                        <div class="schedule-grid-spacer"></div>
                    </div>

                    {% for user in user_list %}

                        {% if user.dept_diff == 'Y' and not forloop.first %}
                            <div class="schedule-grid-row schedule-grid-divider-row">
                                <div class="schedule-grid-divider"></div>
                            </div>
                        {% endif %}

                        <div class="schedule-grid-row schedule-grid-row-data">
                            <div class="schedule-grid-cell left1 align-middle">
                                {% if user.is_new %}
                                    <svg width="30px" height="30px" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" fill="#01babd">
                                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                                        <g id="SVGRepo_iconCarrier">
                                            <title>new-rectangle</title>
                                            <g id="Layer_2" data-name="Layer 2">
                                                <g id="invisible_box" data-name="invisible box">
                                                    <rect width="48" height="48" fill="none"></rect>
                                                </g>
                                                <g id="icons_Q2" data-name="icons Q2">
                                                    <path d="M44,14H4a2,2,0,0,0-2,2V32a2,2,0,0,0,2,2H44a2,2,0,0,0,2-2V16A2,2,0,0,0,44,14ZM17.3,29H14.8l-3-5-.7-1.3h0V29H8.7V19h2.5l3,5,.6,1.3h.1s-.1-1.2-.1-1.6V19h2.5Zm9.1,0H18.7V19h7.6v2H21.2v1.8h4.4v2H21.2v2.1h5.2Zm10.9,0H34.8l-1-4.8c-.2-.8-.4-1.9-.4-1.9h0s-.2,1.1-.3,1.9L32,29H29.6L26.8,19h2.5l1,4.2a20.1,20.1,0,0,1,.5,2.5h0l.5-2.4,1-4.3h2.3l.9,4.3.5,2.4h0l.5-2.5,1-4.2H40Z"></path>
                                                </g>
                                            </g>
                                        </g>
                                    </svg>
                                {% endif %}
                                {{ user.dept }}
                            </div>

                            <div class="schedule-grid-cell left2 align-middle">{{ user.emp_name }}</div>

                            {% for key, value in day_list.items %}
                                <div class="schedule-grid-cell day {% if yearmonth == stand_ym and key == today %}is-today{% endif %}"
                                     data-col="{{ forloop.counter0 }}">
                                    {% with user|get_index:key as schedule %}
                                        <input type="hidden" name="sch_{{ user.id }}_{{ key }}" id="sch_{{ user.id }}_{{ key }}"
                                               value="{{ schedule|default_if_none:'' }}">

                                        {% if stand_ym|concat_date:key < user.join_date or stand_ym|concat_date:key > user.out_date %}
                                            <div class="module_box-disabled"></div>
                                        {% else %}
                                            <div class="module_box" id="insert_{{ user.id }}_{{ key }}"
                                                 onclick="javascript:insert('{{ user.id }}_{{ key }}');"
                                                 style="cursor: pointer;
                                                 {% for module in module_list %}
                                                     {% if module.id == schedule %}
                                                         background-color: {{ module_colors|get_index:module.color }};
                                                     {% endif %}
                                                 {% endfor %}">
                                                {% for module in module_list %}
                                                    {% if module.id == schedule %}
                                                        {% if module.cat == '휴일근로' %}
                                                            <font color="blue">
                                                                {{ module.start_time }}<br>
                                                                {{ module.end_time }}
                                                            </font>
                                                        {% elif module.cat == '유급휴무' %}
                                                            {{ module.name|slice:"0:2" }}<br>
                                                            {{ module.name|slice:"2:4" }}
                                                        {% elif module.cat == '무급휴무' %}
                                                            <font color="red">
                                                                {{ module.name|slice:"0:2" }}<br>
                                                                {{ module.name|slice:"2:4" }}
                                                            </font>
                                                        {% elif module.cat == 'OFF' %}
                                                            -
                                                        {% else %}
                                                            {{ module.start_time }}<br>
                                                            {{ module.end_time }}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            {% endfor %}

                            {% for key, value in next_day_list.items %}
                                <div class="schedule-grid-cell day"
                                     data-col="{{ forloop.counter0|add:day_len }}">
                                    {% with user|get_next_index:key as schedule %}
                                        <input type="hidden" name="sch_{{ user.id }}_n{{ key }}" id="sch_{{ user.id }}_n{{ key }}"
                                               value="{{ schedule|default_if_none:'' }}">

                                        {% if next_ym|concat_date:key < user.join_date or next_ym|concat_date:key > user.out_date %}
                                            <div class="module_box-disabled"></div>
                                        {% else %}
                                            <div class="module_box" id="insert_{{ user.id }}_n{{ key }}"
                                                 onclick="javascript:insert('{{ user.id }}_n{{ key }}');"
                                                 style="cursor: pointer;
                                                 {% for module in module_list %}
                                                     {% if module.id == schedule %}
                                                         background-color: {{ module_colors|get_index:module.color }};
                                                     {% endif %}
                                                 {% endfor %}">
                                                {% for module in module_list %}
                                                    {% if module.id == schedule %}
                                                        {% if module.cat == '휴일근로' %}
                                                            <font color="blue">
                                                                {{ module.start_time }}<br>
                                                                {{ module.end_time }}
                                                            </font>
                                                        {% elif module.cat == '유급휴무' %}
                                                            {{ module.name|slice:"0:2" }}<br>
                                                            {{ module.name|slice:"2:4" }}
                                                        {% elif module.cat == '무급휴무' %}
                                                            <font color="red">
                                                                {{ module.name|slice:"0:2" }}<br>
                                                                {{ module.name|slice:"2:4" }}
                                                            </font>
                                                        {% elif module.cat == 'OFF' %}
                                                            -
                                                        {% else %}
                                                            {{ module.start_time }}<br>
                                                            {{ module.end_time }}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endwith %}
        {% endif %}

    </div>
</form>
{% endblock %}

{% block script %}
<script type="text/javascript">
// ----- Undo / Redo 스택 -----
const undoStack = [];
const redoStack = [];

function applyModuleToCell(target, moduleId) {
    const moduleBoxInsert = document.getElementById("insert_" + target);
    const moduleInput = document.getElementById("sch_" + target);

    if (!moduleBoxInsert || !moduleInput) return;

    moduleInput.value = moduleId || '';

    if (moduleId) {
        const moduleBoxSelected = document.getElementById("select" + moduleId);
        if (moduleBoxSelected) {
            moduleBoxInsert.innerHTML = moduleBoxSelected.innerHTML;
            moduleBoxInsert.style.backgroundColor = moduleBoxSelected.style.backgroundColor;
        }
    } else {
        moduleBoxInsert.innerHTML = "";
        moduleBoxInsert.style.backgroundColor = "";
    }
}

function updateUndoRedoButtons() {
    const undoBtn = document.getElementById("undoBtn");
    const redoBtn = document.getElementById("redoBtn");

    if (undoBtn) undoBtn.disabled = (undoStack.length === 0);
    if (redoBtn) redoBtn.disabled = (redoStack.length === 0);
}

function undo() {
    const last = undoStack.pop();
    if (!last) return;

    applyModuleToCell(last.target, last.from);
    redoStack.push(last);
    updateUndoRedoButtons();
}

function redo() {
    const last = redoStack.pop();
    if (!last) return;

    applyModuleToCell(last.target, last.to);
    undoStack.push(last);
    updateUndoRedoButtons();
}

function insert(target) {
    try {
        const moduleIdSelected = document.querySelector("input[type='radio'][name='module']:checked").value;

        const moduleInput = document.getElementById("sch_" + target);
        const prevModuleId = moduleInput ? (moduleInput.value || null) : null;

        if (prevModuleId === moduleIdSelected) {
            return;
        }

        applyModuleToCell(target, moduleIdSelected);

        undoStack.push({
            target: target,
            from: prevModuleId,
            to: moduleIdSelected,
        });

        redoStack.length = 0;
        updateUndoRedoButtons();
    } catch (e) {
        alert("근무표 변경을 원하시면, 상단 근로모듈을 먼저 선택하세요.");
        return;
    }
}

const save_elements = document.getElementsByClassName("save");
Array.from(save_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        if (confirm("저장하시겠습니까?")) {
            document.getElementById('form').submit();
        }
    });
});

document.addEventListener("DOMContentLoaded", function() {
    const undoBtn = document.getElementById("undoBtn");
    const redoBtn = document.getElementById("redoBtn");

    if (undoBtn) {
        undoBtn.addEventListener("click", function() {
            undo();
        });
    }
    if (redoBtn) {
        redoBtn.addEventListener("click", function() {
            redo();
        });
    }

    updateUndoRedoButtons();

    // ----- 열 hover (GRID 버전) -----
    const dayCells = document.querySelectorAll(".schedule-edit-grid .schedule-grid-cell.day[data-col]");
    dayCells.forEach((cell) => {
        const col = cell.dataset.col;

        cell.addEventListener("mouseover", () => {
            document
                .querySelectorAll(`.schedule-edit-grid .schedule-grid-cell.day[data-col="${col}"]`)
                .forEach((c) => c.classList.add("is-hover"));
        });

        cell.addEventListener("mouseleave", () => {
            document
                .querySelectorAll(`.schedule-edit-grid .schedule-grid-cell.day[data-col="${col}"]`)
                .forEach((c) => c.classList.remove("is-hover"));
        });
    });
});

document.addEventListener('keydown', function(event) {
    function getIndex(o) {
        for (let x = 0; x < o.length; x++) {
            if (o[x].checked) return x;
        }
    }

    const e = event.keyCode;
    const module = document.getElementsByName('module');
    const len = module.length;

    // Ctrl + Z
    if (event.ctrlKey && !event.shiftKey && e === 90) {
        event.preventDefault();
        undo();
        return;
    }
    // Ctrl + Y or Ctrl + Shift + Z
    if (event.ctrlKey && (e === 89 || (event.shiftKey && e === 90))) {
        event.preventDefault();
        redo();
        return;
    }

    // 1~9, 0, -, =
    if (e >= 49 && e <= 57) {
        if (len >= e - 48) module[e - 49].checked = true;
    } else if (e === 48) {
        if (len >= 10) module[9].checked = true;
    } else if (e === 189) {
        if (len >= 11) module[10].checked = true;
    } else if (e === 190) {
        if (len >= 12) module[11].checked = true;
    }
});
</script>
{% endblock %}
