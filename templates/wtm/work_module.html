{% extends 'base.html' %}
{% load pybo_filter %}
{% load humanize %}
{% block content %}
<div class="container my-3">

    <div class="page-header">
        <h4 class="page-title">근로모듈 관리</h4>
    </div>

    <table class="table sticky-top settings-table">
        <thead>
        <tr>
            <th colspan="100%">
                <div class="col-12 text-end">
                    <button type="button" id="btn-save-order" class="btn btn-sm btn-success" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-floppy-fill" viewBox="0 0 16 16">
                          <path d="M0 1.5A1.5 1.5 0 0 1 1.5 0H3v5.5A1.5 1.5 0 0 0 4.5 7h7A1.5 1.5 0 0 0 13 5.5V0h.086a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5H14v-5.5A1.5 1.5 0 0 0 12.5 9h-9A1.5 1.5 0 0 0 2 10.5V16h-.5A1.5 1.5 0 0 1 0 14.5z"/>
                          <path d="M3 16h10v-5.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5zm9-16H4v5.5a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5zM9 1h2v4H9z"/>
                        </svg>
                        <span class="btn-label">저장</span>
                    </button>
                    <a href="{% url 'wtm:work_module_reg' %}" class="btn btn-sm btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clock-fill" viewBox="0 0 16 16">
                          <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                        </svg>
                        등록
                    </a>
                </div>
            </th>
        </tr>
        <tr class="text-center table-light">
            <th></th>
            <th>순서</th>
            <th>표시</th>
            <th>구분</th>
            <th>근로명</th>
            <th>시업시각</th>
            <th>종업시각</th>
            <th>휴게시간1</th>
            <th>휴게시간2</th>
            <th>식대</th>
            <th>삭제</th>
        </tr>
        </thead>
        <tbody id="module-tbody">
        {% if work_module %}
        {% for module in work_module %}
        <tr class="text-center" data-id="{{ module.id }}">
            <td class="text-center">
                <span class="drag-handle" title="드래그하여 순서 변경" aria-label="순서 변경" style="cursor: grab;">
                    <svg width="20px" height="20px" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M9.5 8C10.3284 8 11 7.32843 11 6.5C11 5.67157 10.3284 5 9.5 5C8.67157 5 8 5.67157 8 6.5C8 7.32843 8.67157 8 9.5 8ZM9.5 14C10.3284 14 11 13.3284 11 12.5C11 11.6716 10.3284 11 9.5 11C8.67157 11 8 11.6716 8 12.5C8 13.3284 8.67157 14 9.5 14ZM11 18.5C11 19.3284 10.3284 20 9.5 20C8.67157 20 8 19.3284 8 18.5C8 17.6716 8.67157 17 9.5 17C10.3284 17 11 17.6716 11 18.5ZM15.5 8C16.3284 8 17 7.32843 17 6.5C17 5.67157 16.3284 5 15.5 5C14.6716 5 14 5.67157 14 6.5C14 7.32843 14.6716 8 15.5 8ZM17 12.5C17 13.3284 16.3284 14 15.5 14C14.6716 14 14 13.3284 14 12.5C14 11.6716 14.6716 11 15.5 11C16.3284 11 17 11.6716 17 12.5ZM15.5 20C16.3284 20 17 19.3284 17 18.5C17 17.6716 16.3284 17 15.5 17C14.6716 17 14 17.6716 14 18.5C14 19.3284 14.6716 20 15.5 20Z" fill="currentColor"/>
                    </svg>
                </span>
            </td>
            <td class="row-no">
                {{ module.order }}
            </td>
            <td align="center">
                <div class="module_box" style="background-color: {{ module_colors|get_index:module.color }};">
                    {% if module.cat == '휴일근로' %}
                    <font color="blue">
                        {{ module.start_time }}<br>
                        {{ module.end_time }}
                    </font>
                    {% elif module.cat == '유급휴무' %}
                        {{ module.name|slice:"0:2" }}<br>
                        {{ module.name|slice:"2:4" }}
                    {% elif module.cat == '무급휴무' %}
                    <font color="red">
                        {{ module.name|slice:"0:2" }}<br>
                        {{ module.name|slice:"2:4" }}
                    </font>
                    {% elif module.cat == 'OFF' %}
                        -
                    {% else %}
                        {{ module.start_time }}<br>
                        {{ module.end_time }}
                    {% endif %}
                </div>
            </td>
            <td>{{ module.cat }}</td>
            <td>
                <a href="{% url 'wtm:work_module_modify' module.id %}">{{ module.name }}</a>
            </td>
            <td>{{ module.start_time }}</td>
            <td>{{ module.end_time }}</td>
            <td>
                {% if module.rest1_start_time != '-' %}
                {{module.rest1_start_time}}~{{module.rest1_end_time}}
                {% else %}
                -
                {% endif %}
            </td>
            <td>
                {% if module.rest2_start_time != '-' %}
                {{module.rest2_start_time}}~{{module.rest2_end_time}}
                {% else %}
                -
                {% endif %}
            </td>
            <td class="text-end">
                {% if module.meal_amount %}
                    {{ module.meal_amount|intcomma }}<span class="text-muted small ms-1">원</span>
                {% else %}
                -
                {% endif %}
            </td>
            <td>
                <a href="javascript:void(0)" class="delete btn btn-sm btn-danger"
                   data-uri="{% url 'wtm:work_module_delete' module.id %}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">
                      <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/>
                    </svg>
                    삭제
                </a>
            </td>
        </tr>
        {% endfor %}
        {% else %}
        <tr>
            <td colspan="7" class="text-center">근로모듈이 없습니다.</td>
        </tr>
        {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}
{% block script %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script type="text/javascript">
const delete_elements = document.getElementsByClassName("delete");
Array.from(delete_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        if(confirm("정말 삭제하시겠습니까?")) {
            location.href = this.dataset.uri;
        };
    });
});

function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
}

function collectIds(tbody) {
    return Array.from(tbody.querySelectorAll('tr')).map(tr => tr.dataset.id);
}

function renumberRows(tbody) {
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.forEach((tr, idx) => {
        const noCell = tr.querySelector('.row-no'); // 번호 셀에 클래스 달아두면 즉시 갱신 가능
        if (noCell) noCell.textContent = String(idx + 1);
    });
}

document.addEventListener('DOMContentLoaded', function () {
    const tbody = document.getElementById('module-tbody');
    const btnSave = document.getElementById('btn-save-order');
    if (!tbody || !btnSave) return;

    const csrftoken = getCookie('csrftoken');

    let dirty = false;

    function setDirty(flag) {
        dirty = flag;
        btnSave.disabled = !dirty;
    }

    // 드래그 앤 드롭: 순서만 바꾸고 저장은 안 함
    new Sortable(tbody, {
        animation: 150,
        handle: '.drag-handle',
        draggable: 'tr',
        onEnd: function () {
          setDirty(true);
        },
    });

    // 저장 버튼 클릭 시에만 서버 반영
    btnSave.addEventListener('click', async function () {
        const ids = collectIds(tbody);

        const btnLabel = btnSave.querySelector('.btn-label');

        btnSave.disabled = true;
        btnLabel.textContent = '저장 중...';

        try {
            const res = await fetch("{% url 'wtm:work_module_reorder' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify({ ids }),
            });

            if (!res.ok) {
                showToast('순서 저장에 실패했습니다.', 'error');
                setDirty(true);
                return;
            }

            setDirty(false);
            renumberRows(tbody);
            showToast('저장되었습니다.', 'success');
        } catch (e) {
            showToast('네트워크 오류로 저장에 실패했습니다.', 'error');
            setDirty(true);
        } finally {
            btnLabel.textContent = '저장';
            btnSave.disabled = !dirty;
        }
    });

    // 저장 안 하고 나가려 할 때 경고(원하면)
    window.addEventListener('beforeunload', function (e) {
        if (!dirty) return;
        e.preventDefault();
        e.returnValue = '';
    });
});
</script>
{% endblock %}