{% extends 'base.html' %}
{% load pybo_filter %}
{% block content %}
<div class="container my-3 vacation-page vacation-approvals-page">

    <div class="page-header">
        <h4 class="page-title">연차관리 ▸ 승인관리</h4>
    </div>

    {# ------------------------------------------------------------------ #}
    {# 상단 컨트롤 바: 월 네비 + 탭                                           #}
    {# ------------------------------------------------------------------ #}
    <div class="row align-items-center mb-3 g-2">
        <div class="col-md-6 col-12">
            <div class="d-flex align-items-center gap-2 flex-wrap fs-4">
                <a href="{% url 'vacation:approvals' stand_ym|get_month:-1 %}">
                    <button type="button" class="btn-hover" aria-label="이전 달">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                             fill="currentColor" class="bi bi-chevron-left text-dark"
                             viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                  d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0"/>
                        </svg>
                    </button>
                </a>

                <a href="{% url 'vacation:approvals' stand_ym|get_month:1 %}">
                    <button type="button" class="btn-hover" aria-label="다음 달">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                             fill="currentColor" class="bi bi-chevron-right text-dark"
                             viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                  d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708"/>
                        </svg>
                    </button>
                </a>

                <span class="nativeDatePicker">
                    <input type="month" id="selectYM" name="selectYM" onkeydown="return false" onfocus="this.showPicker()"
                           value="{{stand_ym|slice:'0:4'}}-{{stand_ym|slice:'4:6'}}"/>
                </span>
            </div>
        </div>

        <div class="col-md-6 col-12">
            <div class="d-flex justify-content-md-end justify-content-start gap-2 flex-wrap align-items-center">
                {% include 'vacation/_vacation_tabs.html' with active_tab='ledger' stand_ym=stand_ym %}
            </div>
        </div>
    </div>

    <div class="table-responsive vacation-table-wrapper">
        <table class="table table-sm table-bordered align-middle text-center vacation-table">
            <colgroup>
                <col style="width:6%;">
                <col style="width:12%;">  {# 신청일 #}
                <col style="width:18%;">  {# 직원 #}
                <col style="width:12%;">  {# 구분 #}
                <col style="width:22%;">  {# 기간 #}
                <col style="width:8%;">   {# 일수 #}
                <col style="width:10%;">  {# 상태 #}
                <col style="width:12%;">  {# 액션 #}
            </colgroup>

            <thead class="table-light">
            <tr>
                <th>번호</th>
                <th>신청일</th>
                <th>직원</th>
                <th>구분</th>
                <th>기간</th>
                <th>일수</th>
                <th>상태</th>
                <th></th>
            </tr>
            </thead>

            <tbody>
            {% if request_list %}
            {% for r in request_list %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td class="text-nowrap">{{ r.created_at|date:"Y-m-d" }}</td>
                <td class="text-nowrap">
                    <div class="fw-semibold">{{ r.user.emp_name }}</div>
                    <div class="small text-muted">{{ r.user.dept }} · {{ r.user.position }}</div>
                </td>
                <td class="text-nowrap">{{ r.leave_type|default:"연차" }}</td>
                <td class="text-nowrap">
                    {{ r.start_date|date:"Y-m-d" }} ~ {{ r.end_date|date:"Y-m-d" }}
                </td>
                <td class="text-nowrap fw-semibold">{{ r.days|default:"-" }}</td>
                <td class="text-nowrap">
                    <span class="badge text-bg-light border">{{ r.status_label|default:"대기" }}</span>
                </td>
                <td class="text-nowrap">
                    <div class="d-flex justify-content-center gap-1 flex-wrap">
                        <button type="button" class="btn btn-sm btn-outline-primary">승인</button>
                        <button type="button" class="btn btn-sm btn-outline-danger">승인취소</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="8" class="py-5 text-muted">승인 대상이 없습니다.</td>
            </tr>
            {% endif %}
            </tbody>
        </table>
    </div>

    <form id="searchForm" method="get" action="{% url 'vacation:approvals' stand_ym %}">
        <input type="hidden" id="kw" name="kw" value="{{ kw|default_if_none:'' }}">
    </form>

</div>
{% endblock %}

{% block script %}
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
      const baseUrl = "{% url 'vacation:approvals' '209901' %}".replace('209901/', '');
      const selectMonth = document.getElementById('selectMonth');
      if (selectMonth) {
        selectMonth.addEventListener('change', function () {
          if (!this.value) return;
          const target = this.value.replace(/-/g, '');
          window.location.href = baseUrl + target + '/';
        });
      }

      const btnSearch = document.getElementById('btn_search');
      const searchInput = document.getElementById('search_kw');
      if (searchInput) { searchInput.focus(); searchInput.select(); }

      function doSearch() {
        const kwHidden = document.getElementById('kw');
        if (kwHidden && searchInput) kwHidden.value = searchInput.value;
        document.getElementById('searchForm').submit();
      }

      if (btnSearch) btnSearch.addEventListener('click', doSearch);
      if (searchInput) {
        searchInput.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') { e.preventDefault(); doSearch(); }
        });
      }
    });
</script>
{% endblock %}
